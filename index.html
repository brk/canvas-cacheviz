<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>Canvas Cache Visualizer</title>
    <link rel="stylesheet" type="text/css" media="screen" href="canvas.css" />

    <script src="http://www.google.com/jsapi"></script> 
    <script type="text/javascript">google.load("jquery", 1);</script> 

    <script type="text/javascript" src="store.js"></script>
    <script type="text/javascript" src="cache.js"></script>
    <script type="text/javascript" src="main.js"></script>
  </head>
  <body onload="main();">

    <table>
      <tr>
        <td>Memory Touches</td>
        <td>Cache Hits (green) / Misses (red)</td>
      </tr>
      <tr>
        <td>
          <canvas id="store-canvas"
                  width="200"
                  height="200"
                  ></canvas>
        </td>
        <td>
          <canvas id="cache-canvas"
                  width="200"
                  height="200"
                  ></canvas>
        </td>
        <td><p>TODO: <ul>
          <li>jquery slider to control variable animation speeds</li>
          <li>jQuery slider to scale views -- e.g. use 2 or 4 pixels instead of 1</li>
          <li>On Chrome, at least, repeated runs can lead to de-synced animation... odd, but
          mostly harmless</li>
          <li>non-copy-paste UI for selecting snippets</li>
        </ul>
          </p>
        </td>
      </tr>
      <tr>
        <td>Memory touches are colored by time:<br> black at the start, white at the end</td>
        <td></td>
      </tr>
    </table>
    <hr />
    <table>
      <tr>
        <td>
    <textarea rows="24" cols="80" id="code-textarea" class="console">
// Sequential access by rows
function (a, w, h) {
  for (i = 0; i &lt; h; i++) {
    for (j = 0; j &lt; w; j++) {
      a.touch(i,j);
    }
  }
}
    </textarea>
    <button onclick="window.animate = false; run();">Run</button>
    <button onclick="window.animate = true; run();">Animate</button>
    <div id="error" style="margin-bottom:20px;">
    </div>
      </td>
      <td>
<ul id="snippet-list">
  <li><input type="button" class="title" value="// Sequential access by rows"></input>
  <pre>
function (a, w, h) {
  for (i = 0; i &lt; h; i++) {
    for (j = 0; j &lt; w; j++) {
      a.touch(i,j);
    }
  }
}
  </pre></li>
<!-- ====================================================== -->
<li><input type="button" class="title" value="// Sequential access by columns"></input>
  <pre>
function (a, w, h) {
  for (j = 0; j &lt; w; j++) {
    for (i = 0; i &lt; h; i++) {
      a.touch(i,j);
    }
  }
}
  </pre>
  </pre></li>
<!-- ====================================================== -->
  <li><input type="button" class="title" value="// Simple Matrix Transposition"></input>
  <pre>
function (a, w, h) {
  for (i = 0; i &lt; h; i++) {
    for (j = i+1; j &lt; w; j++) {
      a.touch(i,j);
      a.touch(j,i);
    }
  }
}
  </pre>
  </pre></li>
<!-- ====================================================== -->
<li><input type="button" class="title" value="// Cache-Oblivious Matrix Transposition"></input>
  <pre>
function (a, w, h) {
  var transpose_base = function(a, x, y, w, h) {
    for (i = x; i &lt; x+w; i++) {
      for (j = y; j &lt; y+h; j++) {
        if (j &gt;= i) continue; /* when iterating over a block that
              strapreles the diagonal, only swap the upper triangle */
        a.touch(i,j);
        a.touch(j,i);
      }
    }
  };
  var transpose_block = function(a, x, y, w, h) {
    if ( (x+w) &lt;= y ) return; /* avoid blocks entirely below diagonal */
    if (w &lt;= 8 &amp;&amp; h &lt;= 8) { transpose_base(a, x, y, w, h); return; }
    if (w &gt;= h) {
      var mid = Math.floor(w/2);
      transpose_block(a, x    , y,   mid, h);
      transpose_block(a, x+mid, y, w-mid, h);
    } else {
      var mid = Math.floor(h/2);
      transpose_block(a, x,     y, w,   mid);
      transpose_block(a, x, y+mid, w, h-mid);
    }
  };

  transpose_block(a, 0, 0, w, h);
}
  </pre></li>
</ul>
      </td>
  </body>
</html>
